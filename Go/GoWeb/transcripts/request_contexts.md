## Request Contexts

Another thing that's very important to be aware of in the context of discussing the controller layer is something called the request context. 

So if we look at all the resources that might be involved in processing the web request, we might end up with a map that looks something like this. We're going to start with some middleware that's going to do some pre processing on our request, and maybe some post processing as well. We're going to have a request handler that's actually going to receive the request and access the model layer to apply the main business logic, and then that model layer might call out to a database, it could access another web service, or it could even access the file system. Well the challenge is, since all of the code on the right here, is in the model layer, it really shouldn't be aware that it's operating in the context of a web request. But, there may be some information in the request that is important for them to be aware of. For example, if we're getting user credentials, and we're pulling that off with some middleware, we need to send those credentials along to the model layer so that we can customize our business logic, for example, filtering out records that a user shouldn't be able to see. Another use case would be if we decide to set a timeout on each request. So maybe we have some middleware set up that's going to limit our requests to process within 30 seconds. Well, if the database ends up with a very long query that's going to take five minutes, we need some way for the database access code to know that the request has timed out, and it no longer needs to process that. And the way we're going to do that is by using something called the request context. Now, there are a couple of methods on the request object that are important to be aware of. The first is the context method itself, that's going to return the current context that the request is operating within. And then we have the WithContext method, and we're going to use that if we want to change the context in some way. And we'll see over the next couple of slides how we can do that, because the context object itself doesn't actually allow you to manipulate the context, it's only going to allow you to interrogate the context. If we want to manipulate the context, for example, setting a deadline that the request has to be processed within, then we're going to need to create a new context, and then we can use this WithContext method to change the context of the request. So when we do get a context, what methods do we have available? Well, to look at that, let's look at the context interface. It has a method called deadline that's going to let you know when the context becomes invalid. It has a done method that's going to return a channel that receives a signal once the context is aborted, for example, if the deadline passes. It also has an error method that will let you interrogate the error on the context if something aborts the context early, as well as a value method. And the value method allows you to pull information from the context, so that you can pass information from one layer of your application to another. Now, all of these are read only methods, so you can call the deadline method, and get the deadline of the context, but you can't actually set it with this method. So the way that you can manipulate the context is by creating a new context using different methods that are available in the context package. And those methods are, WithCancel, and what that's going to do, is that's going to return a new context, and along with that context is going to be a cancel method. So if you call that cancel method, it's going to send a signal through the context's done channel, letting everything that's listening to that channel understand that the context has been canceled. WithDeadline is similar to WithCancel, but, in addition to returning that cancel function, it's also going to take a timestamp, and add that timestamp, the done channel's automatically going to receive that completion signal. WithTimeout is similar to WithDeadline, but WithDeadline takes a specific time, and WithTimeout takes a duration. So if you want to request a timeout in 30 seconds, then it's a little bit more convenient to use the WithTimeout function. And then the final function that we have is the WithValue function, and what this will allow you to do is create a new context that adds a new value onto an existing context. So what I'd like to do now, is go back to the course demo, and add a new piece of middleware. And this one's going to use the context to add a timeout handler that not only is our middleware going to be able to take advantage of, but also any other model layer code that we write in the future.